---
title: HGEN McGill, what publications tells us.
author: Jean Monlong
output:
   html_document:
      toc: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```


```{r}
library(rbokeh)
library(ggplot2)
library(dplyr)
library(knitr)
library(magrittr)
library(DT)
library(visNetwork)
library(plotly)
urlpm <- function(df){
    df %>% mutate(title=paste0("[",title,"](http://www.ncbi.nlm.nih.gov/pubmed/",pmid,")")) %>% select(-pmid)
}
```

```{r, cache=TRUE}
pm.df = read.table('./hgen-pubmed.tsv', as.is=TRUE, header=TRUE, sep='\t', quote='')
pm.df %<>% filter(year<2019, !grepl('Published Erratum', type)) %>%
  mutate(author=paste(auth.firstname, auth.lastname),
         big=journal %in% c("Nature", "Science"),
         date=as.Date(date))

## Prepare the 'per-author' data.frame
auth.sum = pm.df %>% filter(hgen) %>% select(author, pmid, big, year) %>%
  unique %>% group_by(author) %>%
  summarize(since=min(year),
            until=max(year),
            pubs=n(),
            pubsPerYear=ifelse(until>since, round(pubs/(until-since),2), NA),
            pubsNatSc=sum(big))

co.df = lapply(auth.sum$author, function(auth){
  pmids = pm.df %>% filter(author==auth) %>% .$pmid %>%
    as.character %>% unique
  pm.df %>% filter(pmid %in% pmids) %>% group_by(author) %>%
    summarize(nb.pubs=n()) %>% ungroup %>% mutate(coauthor=author, author=auth)
})
co.df = do.call(rbind, co.df)
co.df %<>% mutate(hgen=coauthor %in% auth.sum$author)
auth.sum = co.df %>% filter(author!=coauthor) %>%
  group_by(author) %>% summarize(coauthor=n(), coauthor.hgen=sum(hgen)) %>%
  merge(auth.sum)

fam.df = pm.df %>% filter(!is.na(auth.pos)) %>% 
  group_by(pmid) %>% filter(auth.pos==1 | auth.pos==n()) %>%
  filter(n()>1, all(hgen)) %>% arrange(auth.pos) %>%
  summarize(student=author[1], author=author[2]) %>%
  group_by(student, author) %>% summarize(n=n()) %>% filter(n>0)
auth.sum = fam.df %>% group_by(author) %>% summarize(students=n()) %>%
  merge(auth.sum, all.y=TRUE)
```

## First papers in history?

```{r}
pm.df %>% arrange(date) %>% filter(year==1988) %>% select(title, journal, date, pmid) %>% urlpm %>% kable
```

## Wheel of time

```{r}
cit.n = pm.df %>% filter(!grepl('Review', type)) %>%
  select(title, year, cited, pmid, date) %>% unique %>% 
  group_by(year) %>% arrange(desc(cited)) %>%
  mutate(citn=cited/max(cited, na.rm=TRUE), year.rank=factor(1:n())) %>%
  do(head(.,3))

figure(legend_location=NULL, width=800,height=500,tools="reset") %>%
  ly_points(date, cited, data = cit.n, color=year.rank,
            hover=list(title, year, cited)) %>%
  tool_pan %>% tool_wheel_zoom %>% y_axis(log = TRUE)
```

## Number of publications/authors: department growth phase?

```{r}
pm.df %>% filter(hgen) %>% select(year,author) %>% unique %>%
  arrange(year) %>% filter(!duplicated(author)) %>%
  group_by(year) %>% summarize(auth=n()) %>% arrange(year) %>%
  mutate(cauths=cumsum(auth)) %>%
  ggplot(aes(x=year, y=cauths)) + geom_bar(stat="identity")

pm.df %>% filter(hgen) %>% select(year,author) %>% unique %>%
  arrange(year) %>% filter(!duplicated(author)) %>%
  group_by(year) %>% summarize(auth=n()) %>% arrange(year) %>%
  mutate(cauths=cumsum(auth)) %>%
  ggplot(aes(x=year, y=auth)) + geom_bar(stat="identity")

pm.df %>% filter(hgen) %>% select(year, pmid) %>% unique %>%
  group_by(year) %>% summarize(pubs=n()) %>% arrange(year) %>%
  mutate(cpubs=cumsum(pubs)) %>%
  ggplot(aes(x=year, y=pubs)) + geom_bar(stat="identity")

pm.df %>% filter(hgen) %>% select(year, pmid) %>% unique %>%
  group_by(year) %>% summarize(pubs=n()) %>% arrange(year) %>%
  mutate(cpubs=cumsum(pubs)) %>%
  ggplot(aes(x=year, y=cpubs)) + geom_bar(stat="identity")

cauths.df = pm.df %>% filter(hgen) %>% select(year, date, author) %>%
  arrange(date) %>% filter(!duplicated(author)) %>% mutate(cauths=1:n()) %>%
  group_by(date, year) %>% summarize(cauths=max(cauths))

year.cp = 2003
## ggplot(cauths.df, aes(x=date, y=cauths)) + theme_bw() +
##   ylab("cumulative number of authors") +
##   geom_line(size=2, alpha=.8) +
##   geom_smooth(data=subset(cauths.df, year<year.cp), se=FALSE,
##               linetype=2, method="glm", color="red") +
##   geom_smooth(data=subset(cauths.df, year>=year.cp), se=FALSE,
##               linetype=2, method="glm", color="blue") +
##   geom_vline(xintercept=as.numeric(as.Date(paste0(year.cp, "-02-01"))),
##              linetype=2)
year.cp2 = 2010
ggplot(cauths.df, aes(x=date, y=cauths)) + theme_bw() +
  ylab("cumulative number of authors") + geom_line(size=2, alpha=.8) +
  geom_smooth(data=subset(cauths.df, year<year.cp), se=FALSE,
              linetype=2, method="glm", color="red") +
  geom_smooth(data=subset(cauths.df, year>=year.cp & year<year.cp2),
              se=FALSE, linetype=2, method="glm", color="blue") +
  geom_smooth(data=subset(cauths.df, year>=year.cp2), se=FALSE,
              linetype=2, method="glm", color="orange") +
  geom_vline(xintercept=as.numeric(as.Date(paste0(c(year.cp,year.cp2), "-01-01"))), linetype=2)

cauths.df %>% group_by(year) %>% summarize(cauths=max(cauths)) %>%
  arrange(year) %>% mutate(auths=cauths-c(0,cauths[-length(cauths)]),
                           phase=cut(year, c(0,2002,2009,Inf))) %>%
  group_by(phase) %>% summarize(auths=mean(auths))
```

## Numbers

+ `r pm.df %>% filter(hgen) %>% .$pmid %>% unique %>% length` HGEN publications.
+ `r pm.df %>% filter(hgen) %>% .$author %>% unique %>% length` different HGEN authors.


## Summary table

```{r}
auth.sum %>% arrange(desc(pubs)) %>% datatable
```

## Who published the most ?

```{r}
pm.df %>% filter(hgen) %>% group_by(author) %>%
  summarize(pubs=n(), firstDate=min(date), NatSc=sum(big)) %>%
  filter(pubs>2) %>% arrange(NatSc) %>%
  plot_ly(x=firstDate, y=pub, text=author, mode="markers",
          color=factor(NatSc, levels=2:0), size=NatSc+1, colors="Set1",
          width=800)
```

## Paper with most HGEN

*Needs manual curation...*

```{r}
pm.df %>% filter(hgen, aff.single, aff.nchar<400) %>%
  group_by(title, pmid, nb.auth) %>%
  summarize(nb.hgen=n(), prop.hgen=nb.hgen/nb.auth[1],
            authors=paste(author, collapse=",")) %>%
  ungroup %>% select(-nb.auth) %>% arrange(desc(nb.hgen), desc(prop.hgen)) %>%
    head %>% urlpm %>% kable(digits=2)
```	

## HGEN network

```{r}
co.df %<>% filter(hgen, author>coauthor) %>% arrange(desc(nb.pubs))
co.df %>% select(author, coauthor, nb.pubs) %>% datatable

bro.df = co.df %>% head(50)
nodes = data.frame(id=c(bro.df$author, bro.df$coauthor)) %>% unique %>%
  mutate(title=id, label=id)
edges = bro.df %>%
  mutate(from=author, to=coauthor, value=nb.pubs, title=nb.pubs) %>%
  select(from, to, value, title) %>% as.data.frame
visNetwork(nodes, edges) %>% visOptions(highlightNearest = FALSE)
```

## HGEN families

*Doesn't really work...*

```{r}
library(igraph)

fam.df = pm.df %>% filter(!is.na(auth.pos), nb.auth>2) %>% 
  group_by(pmid) %>% filter(auth.pos==1 | auth.pos==n()) %>%
  filter(n()>1, all(hgen)) %>% arrange(auth.pos) %>%
  summarize(student=author[1], author=author[2]) %>%
  group_by(student, author) %>% summarize(n=n()) %>% filter(n>0)

fam.g = rbind(fam.df$author, fam.df$student) %>% as.character %>% graph
gens = lapply(unique(fam.df$author), function(ment){
           paths = all_shortest_paths(fam.g, ment)
           paths.l = unlist(lapply(paths$res, length))
           if(any(paths.l>2)){
               return(paths$res[[which.max(paths.l)]])
           } else {
               return(NULL)
           }
       })
gens = gens[which(!unlist(lapply(gens, is.null)))]
gens.df = data.frame(lineage=unlist(lapply(gens, function(x)paste(as_ids(x), collapse="->"))),
    gens=unlist(lapply(gens, length)),
    stringsAsFactors=FALSE)

gens.df %>% arrange(desc(gens)) %>% datatable
```


## Publication rate per year


## Wordcloud

```{r}
library(wordcloud)
library(tm)

year.s = 2005
year.e = 2010

titleW = pm.df %>% filter(year<=year.e, year>=year.s) %>% .$title %>%
  VectorSource %>% Corpus %>% tm_map(content_transformer(tolower)) %>%
  tm_map(removePunctuation) %>% tm_map(removeNumbers) %>%
  tm_map(removeWords, c(stopwords("SMART"), "the", "and"))
titleW.dtm = TermDocumentMatrix(titleW, control = list(minWordLength = 1))
titleW.f = titleW.dtm %>% as.matrix %>% rowSums %>% sort(decreasing = TRUE)

wordcloud(names(titleW.f), titleW.f, scale=c(4,0.5),
          min.freq = .3, max.words=100,
          colors=brewer.pal(8, "Dark2"))
```


## Limitations

Some affiliations were merged into one. A very long one, so we can catch it sometimes.

```{r}
pm.df %>% select(pmid, aff.nchar) %>% unique %>%
  ggplot(aes(x=aff.nchar)) + geom_histogram()

pm.df %>% select(pmid, aff.nchar) %>% unique %>% filter(aff.nchar>400) %>%
  ggplot(aes(x=aff.nchar)) + geom_histogram()

pm.df %>% select(pmid, aff.nchar) %>% unique %>% filter(aff.nchar>500) %>%
  arrange(aff.nchar) %>% head %>%
    mutate(pubmed=paste0("[pubmed](http://www.ncbi.nlm.nih.gov",pmid,")")) %>%
    kable
```


```{r}
pm.small = pm.df %>% dplyr::rename(Citations=cited, Date=date,
                                   Year=year, Title=title) %>%
  select(Title, Citations, Date, Year) %>% unique

auth.sum %<>% dplyr::rename(Author=author, Students=students,
                            Coauthors=coauthor, HGEN.Coauthors=coauthor.hgen,
                            Since=since, Until=until, Pubs=pubs,
                            PubsPerYear=pubsPerYear) %>% select(-pubsNatSc)

co.df %<>% select(author, coauthor, nb.pubs) %>%
  dplyr::rename(Author=author, Coauthor=coauthor, Pubs=nb.pubs)

save(auth.sum, co.df, pm.small, file="HGenpubs-dataForApp.RData")
```

